<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>GrantMaster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100">

<script>
    // --- Apps Script Backend Interaction Helper ---
    function runAppsScript(functionName, ...args) {
        return new Promise((resolve, reject) => {
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                return reject(new Error('Apps Script environment not available.'));
            }
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                [functionName](...args);
        });
    }

    // --- Alpine.js Global Store for Authentication ---
    document.addEventListener('alpine:init', () => {
        Alpine.store('auth', {
            currentUser: null,
            userData: null,
            loading: true,
            isAuthReady: false,
            async init() {
                this.loading = true;
                try {
                    const authData = await runAppsScript('getCurrentUser');
                    this.currentUser = authData.currentUser;
                    this.userData = authData.userData;
                } catch (error) {
                    console.error("Auth Init Error:", error);
                    this.currentUser = null;
                    this.userData = null;
                } finally {
                    this.isAuthReady = true;
                    this.loading = false;
                }
            }
        });
    });
</script>

<div
    x-data="{
        currentPage: 'login',
        pageParams: {},
        loadingApp: true,
        init() {
            this.$watch('$store.auth.isAuthReady', (isReady) => {
                if (isReady) {
                    if (this.$store.auth.currentUser) {
                        this.currentPage = this.currentPage === 'login' ? 'dashboard' : this.currentPage;
                    } else {
                        this.currentPage = 'login';
                    }
                    this.loadingApp = false;
                }
            });
            this.$store.auth.init();
        },
        navigateTo(page, params = {}) {
            this.currentPage = page;
            this.pageParams = params;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }"
    x-cloak
>
    <div x-show="loadingApp" class="min-h-screen flex items-center justify-center">
        <p>Initializing GrantMaster...</p>
    </div>

    <div x-show="!loadingApp" x-cloak>
        <template x-if="$store.auth.currentUser">
            <nav x-data="{ dropdownOpen: false }" class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-lg sticky top-0 z-50">
                <div class="container mx-auto flex justify-between items-center">
                    <div class="flex items-center space-x-2 cursor-pointer" @click="navigateTo('dashboard')">
                        <span x-html="getLucideIcon('briefcase', 28)"></span> <h1 class="text-2xl font-bold tracking-tight">GrantMaster</h1>
                    </div>
                    <div class="flex items-center space-x-6">
                        <template x-if="$store.auth.userData">
                            <template x-if="$store.auth.userData.role === 'admin'">
                                <button @click="navigateTo('admin')" class="hover:text-blue-200 transition-colors">Admin Panel</button>
                            </template>
                            <template x-if="['admin', 'manager'].includes($store.auth.userData.role)">
                                <button @click="navigateTo('programs')" class="hover:text-blue-200 transition-colors">Grant Programs</button>
                            </template>
                            <template x-if="['seeker', 'manager', 'admin'].includes($store.auth.userData.role)">
                                <button @click="navigateTo('applications')" class="hover:text-blue-200 transition-colors">Applications</button>
                            </template>
                        </template>

                        <div class="relative">
                            <button @click="dropdownOpen = !dropdownOpen" class="flex items-center space-x-2 hover:bg-indigo-600 p-2 rounded-md transition-colors">
                                <span x-html="getLucideIcon('user', 20)"></span>
                                <span x-text="$store.auth.userData?.displayName || $store.auth.currentUser?.email"></span>
                                <span x-html="getLucideIcon('chevron-down', 16)"></span>
                            </button>
                            <div x-show="dropdownOpen" @click.away="dropdownOpen = false" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20 text-gray-700">
                                <button @click="navigateTo('profile'); dropdownOpen = false;" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center space-x-2">
                                    <span x-html="getLucideIcon('settings', 16)"></span> Profile
                                </button>
                                <button @click="handleSignOut()" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center space-x-2">
                                    <span x-html="getLucideIcon('log-out', 16)"></span> Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
        </template>

        <main>
            <template x-if="currentPage === 'login' && !$store.auth.currentUser">
                 <div class="min-h-screen flex items-center justify-center bg-gray-100 py-12 px-4">
                     <div class="max-w-md w-full space-y-8 bg-white p-10 rounded-xl shadow-2xl text-center">
                         <h2 class="mt-6 text-3xl font-extrabold text-gray-900">Welcome to GrantMaster</h2>
                         <p class="text-red-500 text-sm bg-red-100 p-3 rounded-md">
                             Authentication Required. Please log in or grant permissions.
                         </p>
                     </div>
                 </div>
            </template>

            <template x-if="currentPage === 'dashboard' && $store.auth.currentUser">
                <div class="container mx-auto p-8">
                    <template x-if="$store.auth.userData">
                        <div>
                            <h2 x-text="`Good ${(new Date().getHours() < 12) ? 'Morning' : (new Date().getHours() < 18) ? 'Afternoon' : 'Evening'}, ${$store.auth.userData.displayName || $store.auth.currentUser.email}!`" class="text-3xl font-semibold mb-6"></h2>
                            <p class="text-lg mb-4">Your current role: <span x-text="$store.auth.userData.role" class="font-medium capitalize text-indigo-600"></span></p>
                            <p class="text-gray-600 mb-8">Welcome to GrantMaster. Use the navigation bar to access different sections of the platform.</p>

                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                                    <h3 class="text-xl font-semibold mb-3 text-indigo-700 flex items-center"><span x-html="getLucideIcon('search', 24, 'mr-2')"></span>Browse Grant Programs</h3>
                                    <p class="text-gray-600 mb-4">Discover available grant opportunities.</p>
                                    <button @click="navigateTo('programs')" class="bg-indigo-500 text-white px-4 py-2 rounded-md hover:bg-indigo-600 transition-colors">View Programs</button>
                                </div>
                                <template x-if="['manager', 'admin'].includes($store.auth.userData.role)">
                                   <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                                       <h3 class="text-xl font-semibold mb-3 text-purple-700 flex items-center"><span x-html="getLucideIcon('plus-circle', 24, 'mr-2')"></span>Create New Program</h3>
                                       <p class="text-gray-600 mb-4">Set up a new grant program for applicants.</p>
                                       <button @click="navigateTo('programForm', { programId: null })" class="bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 transition-colors">Create Program</button>
                                   </div>
                                </template>
                                <template x-if="$store.auth.userData.role === 'admin'">
                                   <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                                       <h3 class="text-xl font-semibold mb-3 text-red-700 flex items-center"><span x-html="getLucideIcon('users', 24, 'mr-2')"></span>User Management</h3>
                                       <p class="text-gray-600 mb-4">Manage user accounts and roles.</p>
                                       <button @click="navigateTo('admin')" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition-colors">Manage Users</button>
                                   </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </template>

            <template x-if="currentPage === 'programs' && $store.auth.currentUser">
                <div x-data="grantProgramList()" x-init="fetchPrograms()" class="container mx-auto p-8">
                    <div x-show="loading" class="p-8 text-center"><p class="text-xl">Loading grant programs...</p></div>
                    <div x-show="error" class="p-8 text-center text-red-500"><p x-text="error"></p></div>
                    <template x-if="!loading && !error">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-semibold">Grant Programs</h2>
                            <template x-if="$store.auth.userData && ['admin', 'manager'].includes($store.auth.userData.role)">
                                <button @click="navigateTo('programForm', { programId: null })" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 flex items-center transition-colors">
                                    <span x-html="getLucideIcon('plus-circle', 20, 'mr-2')"></span> Create New Program
                                </button>
                            </template>
                        </div>
                        <template x-if="programs.length === 0">
                            <p class="text-gray-600 mt-4">No grant programs are available at the moment.</p>
                        </template>
                        <template x-else>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <template x-for="program in programs" :key="program.id">
                                    <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow flex flex-col justify-between">
                                        <div>
                                            <h3 x-text="program.name" class="text-xl font-semibold text-indigo-700 mb-2"></h3>
                                            <p x-text="program.description" class="text-gray-600 text-sm mb-3 h-16 overflow-hidden"></p>
                                            <div class="text-sm space-y-1 my-4">
                                                <p><span class="font-medium">Status:</span> <span :class="`capitalize px-2 py-0.5 rounded-full text-xs font-semibold ${program.status === 'open' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`" x-text="program.status"></span></p>
                                                <p><span class="font-medium">Dates:</span> <span x-text="formatDate(program.startDate)"></span> - <span x-text="formatDate(program.endDate)"></span></p>
                                            </div>
                                        </div>
                                        <div class="flex space-x-2 mt-auto pt-4 border-t">
                                            <button @click="navigateTo('programDetail', { programId: program.id })" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600 flex items-center">
                                               <span x-html="getLucideIcon('eye', 16, 'mr-1')"></span> View
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </template>
                </div>
            </template>
            </main>
    </div>
</div>

<script>
// --- Alpine.js Component Functions & Helpers ---

function handleSignOut() {
    // IMPORTANT: Replace with your actual deployment URL
    window.top.location.href = 'YOUR_DEPLOYMENT_URL'; 
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        return new Date(dateString).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
    } catch (e) {
        return 'Invalid Date';
    }
}

function getLucideIcon(iconName, size = 24, className = "") {
    const iconMap={'briefcase':'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-briefcase"><path d="M16 20V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/><rect width="20" height="14" x="2" y="6" rx="2"/><path d="M12 12h.01"/></svg>','user':'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>','chevron-down':'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>','settings':'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.25a2 2 0 0 0 .73 2.73l.09.09a2 2 0 0 1 0 2.83l-.08.08a2 2 0 0 0-.73 2.73l.78 1.25a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.78-1.25a2 2 0 0 0-.73-2.73l-.09-.09a2 2 0 0 1 0-2.83l.08-.08a2 2 0 0 0 .73-2.73l-.78-1.25a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>','log-out':'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="17 17 22 12 17 7"/><line x1="22" x2="10" y1="12" y2="12"/></svg>','search':'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>','plus-circle':'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>','users':'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>','eye':'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>'};
    const svg = iconMap[iconName] || '';
    if (!svg) return '';
    const parser = new DOMParser();
    const doc = parser.parseFromString(svg, "image/svg+xml");
    const svgElement = doc.documentElement;
    svgElement.setAttribute('width', size);
    svgElement.setAttribute('height', size);
    if (className) {
        const existingClass = svgElement.getAttribute('class') || '';
        svgElement.setAttribute('class', [existingClass, className].join(' ').trim());
    }
    return svgElement.outerHTML;
}

function grantProgramList() {
    return {
        programs: [],
        loading: true,
        error: '',
        fetchPrograms() {
            this.loading = true;
            this.error = '';
            runAppsScript('queryCollection', 'grantPrograms', [], [{ field: 'createdAt', direction: 'desc' }])
                .then(result => {
                    if (Array.isArray(result)) {
                        this.programs = result;
                    } else {
                        this.error = 'Received invalid data from server.';
                        console.error("Data from server is not a valid array:", result);
                    }
                })
                .catch(err => {
                    this.error = 'Failed to load grant programs.';
                    console.error("fetchPrograms error:", err);
                })
                .finally(() => {
                    this.loading = false;
                });
        },
        formatDate: formatDate
    };
}
// Define other page components like grantProgramForm, etc. here

</script>

</body>
</html>