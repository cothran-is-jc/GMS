<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>GrantMaster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .prose { max-width: 65ch; }
    </style>
</head>
<body class="bg-gray-100">

<script>
    // --- Apps Script Backend Interaction Helper ---
    function runAppsScript(functionName, ...args) {
        return new Promise((resolve, reject) => {
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                return reject(new Error('Apps Script environment not available.'));
            }
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                [functionName](...args);
        });
    }

    // --- Alpine.js Global Store for Authentication ---
    document.addEventListener('alpine:init', () => {
        Alpine.store('auth', {
            currentUser: null,
            userData: null,
            isAuthReady: false,
            async init() {
                try {
                    const authData = await runAppsScript('getCurrentUser');
                    this.currentUser = authData.currentUser;
                    this.userData = authData.userData;
                } catch (error) {
                    console.error("Auth Init Error:", error);
                    this.currentUser = null;
                    this.userData = null;
                } finally {
                    this.isAuthReady = true;
                }
            }
        });
    });
</script>

<div
    x-data="{
        currentPage: 'dashboard',
        pageParams: {},
        init() {
            this.$store.auth.init();
        },
        navigateTo(page, params = {}) {
            this.currentPage = page;
            this.pageParams = params;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }"
    x-cloak
>
    <div x-show="!$store.auth.isAuthReady" class="min-h-screen flex items-center justify-center">
        <p>Initializing GrantMaster...</p>
    </div>

    <div x-show="$store.auth.isAuthReady" x-cloak>

        <template x-if="!$store.auth.currentUser">
            <main class="min-h-screen flex items-center justify-center">
                <p class="p-4 bg-yellow-100 text-yellow-800 rounded-md">Authentication Required. Please ensure you are logged into your Google account and have granted permissions.</p>
            </main>
        </template>

        <template x-if="$store.auth.currentUser">
            <template x-if="$store.auth.userData">
                <nav x-data="{ dropdownOpen: false }" class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-lg sticky top-0 z-50">
                    <div class="container mx-auto flex justify-between items-center">
                        <div class="cursor-pointer" @click="navigateTo('dashboard')"><h1 class="text-2xl font-bold">GrantMaster</h1></div>
                        <div class="flex items-center space-x-6">
                            <template x-if="$store.auth.userData.role === 'admin'">
                                <button @click="navigateTo('admin')" class="hover:text-blue-200">Admin Panel</button>
                            </template>
                            <button @click="navigateTo('programs')" class="hover:text-blue-200">Grant Programs</button>
                        </div>
                    </div>
                </nav>
                <main>
                    <template x-if="currentPage === 'dashboard'">
                        <div class="container mx-auto p-8">
                            <h2 x-text="`Welcome, ${$store.auth.userData.displayName}!`" class="text-3xl font-semibold"></h2>
                        </div>
                    </template>
                     <template x-if="currentPage === 'programs'">
                        <div x-data="grantProgramList()" x-init="fetchPrograms()" class="container mx-auto p-8">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-3xl font-semibold">Grant Programs</h2>
                                <template x-if="$store.auth.userData.role === 'admin'">
                                    <button @click="navigateTo('programForm', { programId: null })" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Create New Program</button>
                                </template>
                            </div>
                            <div x-show="loading" class="text-center p-8"><p>Loading programs...</p></div>
                            <div x-show="error" x-text="error" class="text-red-500 bg-red-100 p-4 rounded-md"></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <template x-for="program in programs" :key="program.id">
                                     <div class="bg-white p-6 rounded-lg shadow-md flex flex-col justify-between">
                                        <div>
                                            <h3 x-text="program.name" class="text-xl font-semibold text-indigo-700 mb-2"></h3>
                                            <p x-text="program.description.substring(0, 100) + (program.description.length > 100 ? '...' : '')" class="text-gray-600 text-sm mb-3 h-16"></p>
                                        </div>
                                        <div class="mt-auto pt-4 border-t">
                                             <button @click="navigateTo('programDetail', { programId: program.id })" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600">View Details</button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                    <template x-if="currentPage === 'programForm'">
                         <div x-data="grantProgramForm(pageParams.programId)" x-init="initForm()" class="container mx-auto p-8">
                            <div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                                <h2 x-text="formTitle" class="text-3xl font-bold mb-6"></h2>
                                <form @submit.prevent="submitForm" class="space-y-6">
                                    </form>
                            </div>
                         </div>
                    </template>
                    <template x-if="currentPage === 'programDetail'">
                        <div x-data="grantProgramDetail(pageParams.programId)" x-init="fetchProgram()" class="container mx-auto p-8">
                            <div x-show="loading" class="text-center p-8"><p>Loading program...</p></div>
                            <div x-show="error" x-text="error" class="text-red-500 bg-red-100 p-4 rounded-md"></div>
                            <template x-if="program && !loading">
                                <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                                    <h2 x-text="program.name" class="text-3xl font-bold text-gray-800 mb-4"></h2>
                                    <p x-text="program.description" class="text-gray-600 prose mb-6"></p>
                                     <button @click="navigateTo('programs')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">&larr; Back to Programs</button>
                                </div>
                            </template>
                        </div>
                    </template>
                </main>
            </template>
             <template x-if="!$store.auth.userData">
                 <div class="min-h-screen flex items-center justify-center">
                    <p class="p-4 bg-red-100 text-red-700 rounded-md">Error: Could not load user profile data. Please contact an administrator.</p>
                </div>
            </template>
        </template>
    </div>
</div>

<script>
    // --- Helper & Component Functions ---

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        // Using UTC to avoid timezone shifting the date
        return new Date(dateString.split('T')[0]).toLocaleDateString(undefined, { timeZone: 'UTC' });
    }

    function grantProgramList() {
        return {
            programs: [],
            loading: true,
            error: '',
            fetchPrograms() {
                this.loading = true;
                this.error = '';
                runAppsScript('queryCollection', 'grantPrograms', [], [{ field: 'createdAt', direction: 'desc' }])
                    .then(result => {
                        if (Array.isArray(result)) {
                            this.programs = result;
                        } else {
                            throw new Error("Data from server was not an array.");
                        }
                    })
                    .catch(err => {
                        this.error = `Failed to load programs: ${err.message}`;
                    })
                    .finally(() => {
                        this.loading = false;
                    });
            }
        };
    }

    function grantProgramForm(programId) {
        return {
            programId: programId,
            program: { name: '', description: '', startDate: '', endDate: '', status: 'pending' },
            formTitle: 'Create New Grant Program',
            submitButtonText: 'Create Program',
            initForm() {
                if (this.programId) {
                    this.formTitle = 'Edit Grant Program';
                    this.submitButtonText = 'Update Program';
                    runAppsScript('getDoc', 'grantPrograms', this.programId)
                        .then(doc => {
                            if (doc) {
                                doc.startDate = doc.startDate ? doc.startDate.split('T')[0] : '';
                                doc.endDate = doc.endDate ? doc.endDate.split('T')[0] : '';
                                this.program = doc;
                            }
                        });
                }
                // Populate the form inside the template
                this.$root.querySelector('form').innerHTML = `
                    <div><label class="block text-sm font-medium">Name</label><input type="text" x-model="program.name" required class="w-full mt-1 border-gray-300 rounded-md"></div>
                    <div><label class="block text-sm font-medium">Description</label><textarea x-model="program.description" rows="4" required class="w-full mt-1 border-gray-300 rounded-md"></textarea></div>
                    <div class="grid grid-cols-2 gap-6">
                        <div><label class="block text-sm font-medium">Start Date</label><input type="date" x-model="program.startDate" required class="w-full mt-1 border-gray-300 rounded-md"></div>
                        <div><label class="block text-sm font-medium">End Date</label><input type="date" x-model="program.endDate" required class="w-full mt-1 border-gray-300 rounded-md"></div>
                    </div>
                    <div><label class="block text-sm font-medium">Status</label><select x-model="program.status" class="w-full mt-1 border-gray-300 rounded-md"><option value="pending">Pending</option><option value="open">Open</option><option value="closed">Closed</option></select></div>
                    <div class="flex justify-end space-x-4 pt-4"><button type="button" @click="navigateTo('programs')" class="bg-gray-200 px-4 py-2 rounded-md">Cancel</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md" x-text="submitButtonText"></button></div>
                `;
            },
            submitForm() {
                const action = this.programId 
                    ? runAppsScript('updateDoc', 'grantPrograms', this.programId, this.program)
                    : runAppsScript('addDoc', 'grantPrograms', this.program);
                
                action.then(() => {
                    this.navigateTo('programs');
                }).catch(err => alert(`Error: ${err.message}`));
            }
        };
    }

    function grantProgramDetail(programId) {
        return {
            programId: programId,
            program: null,
            loading: true,
            error: '',
            fetchProgram() {
                this.loading = true;
                this.error = '';
                runAppsScript('getDoc', 'grantPrograms', this.programId)
                    .then(result => {
                        if (result) {
                            this.program = result;
                        } else {
                            this.error = 'Program not found.';
                        }
                    })
                    .catch(err => {
                        this.error = `Failed to load details: ${err.message}`;
                    })
                    .finally(() => {
                        this.loading = false;
                    });
            }
        };
    }
</script>

</body>
</html>