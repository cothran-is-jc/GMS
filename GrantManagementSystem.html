<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>GrantMaster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100">

<script>
    // --- Apps Script Backend Interaction Helper ---
    function runAppsScript(functionName, ...args) {
        return new Promise((resolve, reject) => {
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                console.warn("Apps Script environment not found. Using mock data.");
                // Mock responses for local development
                if (functionName === 'getCurrentUser') {
                    resolve({ currentUser: { email: 'dev@local.com', uid: 'dev1' }, userData: { role: 'admin', displayName: 'Dev Admin' } });
                } else {
                    resolve([]);
                }
                return;
            }
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                [functionName](...args);
        });
    }

    // --- Alpine.js Global Store for Authentication ---
    document.addEventListener('alpine:init', () => {
        Alpine.store('auth', {
            currentUser: null,
            userData: null,
            loading: true,
            isAuthReady: false,
            async init() {
                this.loading = true;
                try {
                    const authData = await runAppsScript('getCurrentUser');
                    this.currentUser = authData.currentUser;
                    this.userData = authData.userData;
                } catch (error) {
                    console.error("Auth Init Error:", error);
                    this.currentUser = null;
                    this.userData = null;
                } finally {
                    this.isAuthReady = true;
                    this.loading = false;
                }
            }
        });
    });
</script>

<div
    x-data="{
        currentPage: 'login',
        pageParams: {},
        loadingApp: true,
        init() {
            this.$watch('$store.auth.isAuthReady', (isReady) => {
                if (isReady) {
                    if (this.$store.auth.currentUser) {
                        this.currentPage = 'dashboard';
                    } else {
                        this.currentPage = 'login';
                    }
                    this.loadingApp = false;
                }
            });
            this.$store.auth.init();
        },
        navigateTo(page, params = {}) {
            this.currentPage = page;
            this.pageParams = params;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }"
    x-cloak
>
    <div x-show="loadingApp" class="min-h-screen flex items-center justify-center">
        <p class="text-xl text-slate-600">Initializing GrantMaster...</p>
    </div>

    <div x-show="!loadingApp" x-cloak>
        <template x-if="$store.auth.currentUser">
            <nav x-data="{ dropdownOpen: false }" class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-lg sticky top-0 z-50">
                <div class="container mx-auto flex justify-between items-center">
                    <div class="flex items-center space-x-2 cursor-pointer" @click="navigateTo('dashboard')">
                        <span class="font-bold text-2xl">GrantMaster</span>
                    </div>
                    <div x-show="$store.auth.userData" class="flex items-center space-x-6">
                        <template x-if="$store.auth.userData.role === 'admin'">
                            <button @click="navigateTo('admin')" class="hover:text-blue-200">Admin Panel</button>
                        </template>
                        <button @click="navigateTo('programs')" class="hover:text-blue-200">Grant Programs</button>
                        <button @click="navigateTo('applications')" class="hover:text-blue-200">Applications</button>
                        
                        <div class="relative">
                            <button @click="dropdownOpen = !dropdownOpen" class="flex items-center space-x-2 hover:bg-indigo-600 p-2 rounded-md">
                                <span x-text="$store.auth.userData.displayName || $store.auth.currentUser.email"></span>
                                <span>&#9662;</span>
                            </button>
                            <div x-show="dropdownOpen" @click.away="dropdownOpen = false" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20 text-gray-700">
                                <a href="#" @click.prevent="navigateTo('profile'); dropdownOpen = false;" class="block px-4 py-2 text-sm">Profile</a>
                                <a href="#" @click.prevent="handleSignOut()" class="block px-4 py-2 text-sm">Sign Out</a>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
        </template>

        <main>
            <template x-if="currentPage === 'login' && !$store.auth.currentUser">
                 <div class="min-h-screen flex items-center justify-center">
                     <p>Authentication Required. Please log in.</p>
                 </div>
            </template>

            <template x-if="currentPage === 'dashboard' && $store.auth.userData">
                <div class="container mx-auto p-8">
                    <h2 x-text="`Good ${(new Date().getHours() < 12) ? 'Morning' : 'Afternoon'}, ${$store.auth.userData.displayName}!`" class="text-3xl font-semibold mb-6"></h2>
                    <p class="text-lg mb-4">Your role: <span x-text="$store.auth.userData.role" class="font-medium capitalize text-indigo-600"></span></p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-3">Browse Programs</h3>
                            <button @click="navigateTo('programs')" class="bg-indigo-500 text-white px-4 py-2 rounded-md">View Programs</button>
                        </div>
                        <template x-if="$store.auth.userData.role === 'admin'">
                           <div class="bg-white p-6 rounded-lg shadow-md">
                               <h3 class="text-xl font-semibold mb-3">Create New Program</h3>
                               <button @click="navigateTo('programForm', { programId: null })" class="bg-purple-500 text-white px-4 py-2 rounded-md">Create Program</button>
                           </div>
                        </template>
                    </div>
                </div>
            </template>

            <template x-if="currentPage === 'programs'">
                <div x-data="grantProgramList()" x-init="fetchPrograms()" class="container mx-auto p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-semibold">Grant Programs</h2>
                        <template x-if="$store.auth.userData && $store.auth.userData.role === 'admin'">
                            <button @click="navigateTo('programForm', { programId: null })" class="bg-indigo-600 text-white px-4 py-2 rounded-md">Create New Program</button>
                        </template>
                    </div>
                    <div x-show="loading" class="text-center"><p>Loading programs...</p></div>
                    <div x-show="error" x-text="error" class="text-red-500 bg-red-100 p-4 rounded-md"></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <template x-for="program in programs" :key="program.id">
                            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col">
                                <h3 x-text="program.name" class="text-xl font-semibold text-indigo-700"></h3>
                                <p x-text="program.description.substring(0, 100) + '...'" class="text-gray-600 my-2 flex-grow"></p>
                                <div class="mt-4 pt-4 border-t">
                                    <p><strong>Status:</strong> <span x-text="program.status" class="font-medium capitalize"></span></p>
                                    <p><strong>Dates:</strong> <span x-text="formatDate(program.startDate)"></span> - <span x-text="formatDate(program.endDate)"></span></p>
                                    <button @click="navigateTo('programDetail', { programId: program.id })" class="mt-4 bg-blue-500 text-white px-3 py-1 rounded-md text-sm">View Details</button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
            
            </main>
    </div>
</div>

<script>
// --- Helper & Component Functions ---

function handleSignOut() {
    window.top.location.href = "YOUR_DEPLOYMENT_URL_HERE"; 
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        return new Date(dateString.split('T')[0]).toLocaleDateString(undefined, { timeZone: 'UTC' });
    } catch (e) {
        return 'Invalid Date';
    }
}

function grantProgramList() {
    return {
        programs: [],
        loading: true,
        error: '',
        fetchPrograms() {
            this.loading = true;
            this.error = '';
            runAppsScript('queryCollection', 'grantPrograms', [], [{ field: 'createdAt', direction: 'desc' }])
                .then(result => {
                    if(Array.isArray(result)) {
                        this.programs = result;
                    } else {
                        throw new Error("Data from server was not an array.");
                    }
                })
                .catch(err => {
                    this.error = `Failed to load programs: ${err.message}`;
                    console.error("fetchPrograms error:", err);
                })
                .finally(() => { this.loading = false; });
        }
    };
}
</script>

</body>
</html>